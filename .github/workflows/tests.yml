name: Run the tests for the project

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  # tests-unix:
  #   runs-on: ubuntu-latest
  #   steps:
  #   - uses: actions/checkout@v3
  #   - name: Run tests Unix
  #     working-directory: ./canyon_sql
  #     run: cargo test --verbose
    
  # tests-windows:
  #   runs-on: windows-latest
  #   steps:
  #   - uses: actions/checkout@v3
  #   - name: Run tests for Windows
  #     working-directory: ./canyon_sql
  #     run: cargo test --verbose

  # tests-macos:
  #   runs-on: macos-latest
  #   steps:
  #   - uses: actions/checkout@v3
  #   - name: Run tests for macOS
  #     working-directory: ./canyon_sql
  #     run: cargo test --verbose

  gcov:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v1
        - uses: actions-rs/toolchain@v1
          with:
            toolchain: nightly
            override: true
        - uses: actions-rs/cargo@v1
          with:
            command: test
            args: --all-features --no-fail-fast
          env:
            CARGO_INCREMENTAL: '0'
            RUSTFLAGS: '-Zprofile -Ccodegen-units=1 -Cinline-threshold=0 -Clink-dead-code -Coverflow-checks=off -Cpanic=abort -Zpanic_abort_tests'
            RUSTDOCFLAGS: '-Zprofile -Ccodegen-units=1 -Cinline-threshold=0 -Clink-dead-code -Coverflow-checks=off -Cpanic=abort -Zpanic_abort_tests'
        - uses: actions-rs/grcov@v0.1